<<<<<<< HEAD
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>過去データ</title>
    <link rel="stylesheet" href="history.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container">
        <h2>過去のデータ</h2>
        <div id="monthlyData"></div>
    </div>
    <a href="main.html" id="backToMainBtn">打刻画面に戻る</a>
    <script>
        // Firebase構成
        const firebaseConfig = {
            apiKey: "AIzaSyBWu2dCPqq8jcxjMuxw4iL3ckE1PfCIF90",
            authDomain: "leaving-work-31983.firebaseapp.com",
            databaseURL: "https://leaving-work-31983-default-rtdb.firebaseio.com",
            projectId: "leaving-work-31983",
            storageBucket: "leaving-work-31983.appspot.com",
            messagingSenderId: "262714318259",
            appId: "1:262714318259:web:6f526f8ee38387ae6affc6",
            measurementId: "G-YWBGTWQZQQ"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentUser = null;

        document.addEventListener("DOMContentLoaded", function() {
            currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                window.location.href = "index.html";
            } else {
                displayMonthlyData();
            }
        });

        function displayMonthlyData() {
            db.ref("attendanceData").once("value", function(snapshot) {
                let dataByMonth = {};
                snapshot.forEach(function(child) {
                    let entry = child.val();
                    if (currentUser === "admin" || entry.name === currentUser) {
                        let startTime = new Date(entry.startTime);
                        let endTime = new Date(entry.endTime);
                        if (isNaN(startTime.getTime()) || isNaN(endTime.getTime())) return;
                        let year = startTime.getFullYear();
                        let month = startTime.getMonth() + 1; // 1-12
                        let key = `${year}年${month}月`;
                        if (!dataByMonth[key]) dataByMonth[key] = [];
                        dataByMonth[key].push({
                            ...entry,
                            startTime,
                            endTime,
                            id: child.key   // ←ここを追加
                        });
                    }
                });

                // 月ごとに並び替え（新しい月が上）
                let months = Object.keys(dataByMonth).sort((a, b) => {
                    let [ay, am] = a.match(/\d+/g).map(Number);
                    let [by, bm] = b.match(/\d+/g).map(Number);
                    if (ay !== by) return by - ay;
                    return bm - am;
                });

                let html = "";
                months.forEach(monthKey => {
                    let entries = dataByMonth[monthKey];
                    // 合計勤務時間計算
                    let totalMs = 0;
                    entries.forEach(e => {
                        let diff = e.endTime - e.startTime;
                        if (diff > 0) totalMs += diff;
                    });
                    let totalMinutes = Math.floor(totalMs / (1000 * 60));
                    let hours = Math.floor(totalMinutes / 60);
                    let minutes = totalMinutes % 60;
                    let totalStr = `${hours}時間${minutes > 0 ? minutes + "分" : ""}`;

                    html += `<div class="month-header">${monthKey}</div>`;
                    html += `<div class="month-total">合計: ${totalStr}</div>`;
                    html += `<table class="month-table" id="dataTable">
                        <thead>
                            <tr>
                                <th>日付</th>
                                <th>出勤時間</th>
                                <th>退勤時間</th>
                                <th>会場</th>
                                <th class="edit-header">修正</th>
                            </tr>
                        </thead>
                        <tbody>`;
                    // 今日の日付を取得
                    const today = new Date();
                    const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                    entries.sort((a, b) => b.startTime - a.startTime).forEach(entry => {
                        const startDate = (entry.startTime instanceof Date) ? entry.startTime : new Date(entry.startTime);
                        const today = new Date();
                        // 今日の日付（年月日）で判定
                        const isToday =
                            startDate.getFullYear() === today.getFullYear() &&
                            startDate.getMonth() === today.getMonth() &&
                            startDate.getDate() === today.getDate();
                        const canEdit = isToday;

                        const m = String(startDate.getMonth() + 1).padStart(2, '0');
                        const d = String(startDate.getDate()).padStart(2, '0');
                        const dateStr = `${m}/${d}`;
                        const startStr = startDate.toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'});
                        const endStr = entry.endTime instanceof Date
                            ? entry.endTime.toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'})
                            : new Date(entry.endTime).toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'});

                        html += `<tr>
                            <td>${dateStr}</td>
                            <td class="time-col">${startStr}</td>
                            <td class="time-col">${endStr}</td>
                            <td>${entry.venue}</td>
                            <td>
                                ${canEdit
                ? `<a href="#" class="edit-link" data-id="${entry.id}"><img src="pen.png" alt="修正" class="edit-icon"></a>`
                : "---"}
                            </td>
                        </tr>`;
                    });
                    html += `</tbody></table>`;
                });

                document.getElementById("monthlyData").innerHTML = html || "<p>データがありません。</p>";
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            // edit-linkクリック時の処理
            document.getElementById("monthlyData").addEventListener("click", function(e){
                if(e.target.closest('.edit-link')){
                    e.preventDefault();
                    const a = e.target.closest('.edit-link');
                    const id = a.getAttribute('data-id');
                    db.ref("attendanceData/" + id).once("value", function(snapshot){
                        const data = snapshot.val();
                        if(data){
                            db.ref("edit-one/" + id).set({
                                ...data,
                                id: id
                            }, function(){
                                window.location.href = "edit.html?id=" + id;
                            });
                        }
                    });
                }
            });
        });
    </script>
</body>
=======
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>過去データ</title>
    <link rel="stylesheet" href="history.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container">
        <h2>過去のデータ</h2>
        <div id="monthlyData"></div>
    </div>
    <a href="main.html" id="backToMainBtn">打刻画面に戻る</a>
    <script>
        // Firebase構成
        const firebaseConfig = {
            apiKey: "AIzaSyBWu2dCPqq8jcxjMuxw4iL3ckE1PfCIF90",
            authDomain: "leaving-work-31983.firebaseapp.com",
            databaseURL: "https://leaving-work-31983-default-rtdb.firebaseio.com",
            projectId: "leaving-work-31983",
            storageBucket: "leaving-work-31983.appspot.com",
            messagingSenderId: "262714318259",
            appId: "1:262714318259:web:6f526f8ee38387ae6affc6",
            measurementId: "G-YWBGTWQZQQ"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentUser = null;

        document.addEventListener("DOMContentLoaded", function() {
            currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                window.location.href = "index.html";
            } else {
                displayMonthlyData();
            }
        });

        function displayMonthlyData() {
            db.ref("attendanceData").once("value", function(snapshot) {
                let dataByMonth = {};
                snapshot.forEach(function(child) {
                    let entry = child.val();
                    if (currentUser === "admin" || entry.name === currentUser) {
                        let startTime = new Date(entry.startTime);
                        let endTime = new Date(entry.endTime);
                        if (isNaN(startTime.getTime()) || isNaN(endTime.getTime())) return;
                        let year = startTime.getFullYear();
                        let month = startTime.getMonth() + 1; // 1-12
                        let key = `${year}年${month}月`;
                        if (!dataByMonth[key]) dataByMonth[key] = [];
                        dataByMonth[key].push({
                            ...entry,
                            startTime,
                            endTime,
                            id: child.key   // ←ここを追加
                        });
                    }
                });

                // 月ごとに並び替え（新しい月が上）
                let months = Object.keys(dataByMonth).sort((a, b) => {
                    let [ay, am] = a.match(/\d+/g).map(Number);
                    let [by, bm] = b.match(/\d+/g).map(Number);
                    if (ay !== by) return by - ay;
                    return bm - am;
                });

                let html = "";
                months.forEach(monthKey => {
                    let entries = dataByMonth[monthKey];
                    // 合計勤務時間計算
                    let totalMs = 0;
                    entries.forEach(e => {
                        let diff = e.endTime - e.startTime;
                        if (diff > 0) totalMs += diff;
                    });
                    let totalMinutes = Math.floor(totalMs / (1000 * 60));
                    let hours = Math.floor(totalMinutes / 60);
                    let minutes = totalMinutes % 60;
                    let totalStr = `${hours}時間${minutes > 0 ? minutes + "分" : ""}`;

                    html += `<div class="month-header">${monthKey}</div>`;
                    html += `<div class="month-total">合計: ${totalStr}</div>`;
                    html += `<table class="month-table" id="dataTable">
                        <thead>
                            <tr>
                                <th>日付</th>
                                <th>出勤時間</th>
                                <th>退勤時間</th>
                                <th>会場</th>
                                <th class="edit-header">修正</th>
                            </tr>
                        </thead>
                        <tbody>`;
                    // 今日の日付を取得
                    const today = new Date();
                    const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                    entries.sort((a, b) => b.startTime - a.startTime).forEach(entry => {
                        const startDate = (entry.startTime instanceof Date) ? entry.startTime : new Date(entry.startTime);
                        const today = new Date();
                        // 今日の日付（年月日）で判定
                        const isToday =
                            startDate.getFullYear() === today.getFullYear() &&
                            startDate.getMonth() === today.getMonth() &&
                            startDate.getDate() === today.getDate();
                        const canEdit = isToday;

                        const m = String(startDate.getMonth() + 1).padStart(2, '0');
                        const d = String(startDate.getDate()).padStart(2, '0');
                        const dateStr = `${m}/${d}`;
                        const startStr = startDate.toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'});
                        const endStr = entry.endTime instanceof Date
                            ? entry.endTime.toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'})
                            : new Date(entry.endTime).toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'});

                        html += `<tr>
                            <td>${dateStr}</td>
                            <td class="time-col">${startStr}</td>
                            <td class="time-col">${endStr}</td>
                            <td>${entry.venue}</td>
                            <td>
                                ${canEdit
                ? `<a href="#" class="edit-link" data-id="${entry.id}"><img src="pen.png" alt="修正" class="edit-icon"></a>`
                : "---"}
                            </td>
                        </tr>`;
                    });
                    html += `</tbody></table>`;
                });

                document.getElementById("monthlyData").innerHTML = html || "<p>データがありません。</p>";
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            // edit-linkクリック時の処理
            document.getElementById("monthlyData").addEventListener("click", function(e){
                if(e.target.closest('.edit-link')){
                    e.preventDefault();
                    const a = e.target.closest('.edit-link');
                    const id = a.getAttribute('data-id');
                    db.ref("attendanceData/" + id).once("value", function(snapshot){
                        const data = snapshot.val();
                        if(data){
                            db.ref("edit-one/" + id).set({
                                ...data,
                                id: id
                            }, function(){
                                window.location.href = "edit.html?id=" + id;
                            });
                        }
                    });
                }
            });
        });
    </script>
</body>
>>>>>>> b02b82a2a93087fe68cf57b85fd2351527dcad27
</html>